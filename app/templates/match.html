{% extends 'layout.html' %}

{% block content %}
<!-- Scripting -->
<script>
    // 'correctItem' dict for posting later
    var correctItem = {
        'match' : '',
        'sublist' : {{ sublist|tojson }}
    }; 

    // counts the correct items
    var correctCount = 0;

    // holds count if buton clicked is first or
    // second
    var clickCount = 0;

    // holds the id of the first button clicked
    var id = null;

    // holds the object of the first button clicked
    var first_button = null;

    // holds the answer for the first button clicked
    var first_answer = null;

    function rightOrWrong(input, answer) {
        input.addEventListener('click', function () {

            // if 'count' is eual to 0...
            if (clickCount == 0) {

                // increments 'count' by 1
                clickCount++;

                // equates 'id' to its intented value
                id = input.id;

                // equates 'first_button' to its intended value
                first_button = input;

                // equates 'first_answer' to its intended value
                first_answer = answer.value;

                // changes the background color of the clicked
                // button into light gray
                input.style.backgroundColor = '#d3d3d3';

                // console logs for debugging
                console.log(`The count is ${clickCount}`);
                console.log(`You clicked button ${id}`);

                // stops the propagation of the click:
                // stops the function from executing up
                // to 'count 1'
                input.stopImmediatePropagation();
            }

            // if count is equal to 1...
            if (clickCount == 1) {

                // and if the button clicked is the same
                // as the first one...
                if (id == input.id) {

                    // increments 'count'
                    clickCount++;

                    // resets the background color
                    input.style.backgroundColor = '';

                    // console logs for debugging
                    console.log(`The count is ${clickCount}`);
                    console.log(`You took your input back.`)

                    // resets 'count' back to 0
                    clickCount = 0;
                }

                // if the button clicked is NOT the same
                // as the first one...
                else if (id != input.id) {

                    // and if the 'input' of the second button
                    // is the same as the answer to the first
                    // button clicked...
                    if (input.innerText == first_answer) {

                        // changes the background color of first and
                        // second button clicked to green
                        input.style.backgroundColor = '#90ee90';
                        first_button.style.backgroundColor = '#90ee90';
                        
                        // disables the two buttons
                        input.setAttribute('disabled', 'true');
                        first_button.setAttribute('disabled', 'true');
                        
                        // increments 'corectItem'
                        correctCount++;

                        correctItem['match'] = answer.getAttribute('data-correct_id');
                        console.log(correctItem['match']); //  DEBUG

                        // using AJAX, use an XMLHttpRequest() to pass the id
                        const xhttp = new XMLHttpRequest();
                        xhttp.onload = function () {
                            console.log(xhttp.responseText);
                        };
                        xhttp.open('POST', '{{ url_for('progress_tracker') }}', true);
                        xhttp.setRequestHeader('Content-Type', 'application/json');
                        xhttp.send(JSON.stringify({correctItem}));
                        

                        // console log for debugging
                        console.log('You got it right!');
                        clickCount = 0;

                        // if 'correctCount' = 5
                        if (correctCount == 5) {
                            location.reload();
                        };
                    }

                    // if its not the same as the answer to the
                    // first button...
                    if (input.innerText != first_answer) {

                        // resets the background color
                        input.style.backgroundColor = '';
                        first_button.style.backgroundColor = '';

                        // console log for debugging
                        console.log('Not quite right!');

                        // resets the count
                        clickCount = 0;
                    }
                }
            }
        }
    )};
</script>

<!-- While there is no value for 'sublist' -->
{% if not sublist %}

Choose a sublist:
<form action='{{url_for('match')}}' method='GET'>
    <div class='quiz-sublist-background'>
        <div class='quiz-sublist-wrapper'>
            <button class='quiz-sublist-button' name='sublist' type='submit' value='1'>Sublist 1</button>
            <button class='quiz-sublist-button' name='sublist' type='submit' value='2'>Sublist 2</button>
            <button class='quiz-sublist-button' name='sublist' type='submit' value='3'>Sublist 3</button>
        </div>
    </div>
</form>


{% endif %}

<!-- When 'sublist' has value -->
{% if sublist %}

<!-- counters for 'random_words' and 'random_definitions' - 
 this is for ensuring that the for loop of each button goes
 through each item of the lists. -->
{% set word_counter = [] %}
{% set definition_counter = [] %}

<p>You picked Sublist No.{{ sublist }}</p>

<!-- creates two shuffled lists from 'random_words', each to be used
 by 'word' type buttons and 'definition' type buttons -->
{% set word_random_words = random_words|shuffle %}
{% set definition_random_words = random_words|shuffle %}

{% for i in range(10) %}
    <!-- temp solution only, just to make sure that
     there are five buttons per row-->
    {% if loop.index == 6 %}
        <br>
    {% endif %}

    <button class='match-choices' id='a{{ loop.index }}'>

        <!-- if the item in 'arrange' is 0 -->
        {% if arrange[loop.index - 1] == 0 %}

            <!-- dumps the latest word from 'word_random_words' -->
            {{ word_random_words[word_counter|length] }}

            <!-- holds the answer (or rather, the match) -->
            <input type='hidden' id='aa{{ loop.index }}' value='{{ word_random_words[word_counter|length].definition[0] }}' data-correct_id='{{ word_random_words[word_counter|length].id }}'></input>

            <!-- increments the counter (afaik, there is no
             increment for jinja, so I used a list that I will
             append to and I will count how many items it has) -->
            {% set __ = word_counter.append(1) %}

        <!-- if the item in 'arrange' is 1 -->
        {% elif arrange[loop.index - 1] == 1 %}

            <!-- dumps the latest definition from 'definition_random_word' -->
            {{ definition_random_words[definition_counter|length].definition[0] }}

            <!-- holds the match -->
            <input type='hidden' id='aa{{ loop.index }}' value='{{ definition_random_words[definition_counter|length] }}' data-correct_id='{{ definition_random_words[definition_counter|length].id }}'></input>

            <!-- increments the counter, same method -->
            {% set __ = definition_counter.append(1) %}
        {% endif %}
    </button>

    <!-- calls the function for doing the complicated bits -->
    <script>
        rightOrWrong( document.getElementById('a{{ loop.index }}'),
                    document.getElementById('aa{{ loop.index }}'),
                );
    </script>
{% endfor %}

{% endif %}
{% endblock %}