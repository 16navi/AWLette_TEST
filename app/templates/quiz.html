{% extends 'layout.html' %}
{% block content %}

<!-- Scripting -->
<script>
    console.log({{ question_amount|tojson }});

    var correctList = [];
    var correctItem = {
            'quiz' : '',
            'sublist' : {{ sublist|tojson }}
        };

    function rightOrWrong(question, classmates, submit) { 
    
        classmates.forEach(function(classmate) {
            classmate.isInput = false;
            classmate.firstClick = false;

            classmate.addEventListener('click', function(){
                if (classmate.firstClick == false) {
                    classmate.isInput = true;
                    console.log(`You're input is now button ${classmate.id}`);
                    for (let i of classmates) {
                        i.style.backgroundColor = '';
                        i.firstClick = false;
                    };
                    classmate.firstClick = true;
                    classmate.style.backgroundColor = '#a3a3a3';
                    classmate.stopImmediatePropagation();
                };
                if (classmate.firstClick == true) {
                    classmate.isInput = null;
                    classmate.firstClick = false;
                    console.log('You took your input back.');
                    classmate.style.backgroundColor = '';
                    classmate.stopImmediatePropagation();
                };
            });
        });

        submit.addEventListener('click', function() {
            input = null;

            for (let i of classmates) {
                if (i.isInput == true) {
                    input = i
                };
            };

            if (input == null) {
                console.log(`You got Question ${question.id} wrong...`);
                for (let i of classmates) {
                    i.setAttribute('disabled', 'true');
                    if (i.id.replace('b', '') == question.id.replace('a', '')) {
                        i.style.backgroundColor = '#90ee90';
                    };
                };
                correctList.push(0);
                console.log(correctList);
            } else if (input.id.replace('b', '') == question.id.replace('a', '')) {
                console.log(input.id);
                console.log(`You got Question ${question.id} right!`);
                input.style.backgroundColor = '#90ee90';
                for (let i of classmates) {
                    i.setAttribute('disabled', 'true');
                };
                correctList.push(input.id.slice(2));
                console.log(correctList);
            } else if (input.id.replace('b', '') != question.id.replace('a', '')) {
                console.log(input.id);
                console.log(`You got Question ${question.id} wrong...`);
                input.style.backgroundColor = '#ef7a71';
                for (let i of classmates) {
                    i.setAttribute('disabled', 'true');
                    if (i.id.replace('b', '') == question.id.replace('a', '')) {
                        i.style.backgroundColor = '#90ee90';
                    };
                };
                correctList.push(0);
                console.log(correctList.length);
            };

            function correctListIsComplete() {
                return new Promise((resolve) => {
                    if (correctList.length == {{ question_amount|tojson }}) {
                        resolve(true);
                    };
                });
            };          

            async function postCorrectItem() {
                waitFor = await correctListIsComplete();
                if (waitFor == true) {
                    for (let listId of correctList) {
                        if (listId != 0) {
                            setTimeout( function() {
                                correctItem['quiz'] = listId;
                                // using AJAX, use an XMLHttpRequest() to pass the id
                                const xhttp = new XMLHttpRequest();
                                xhttp.onload = function () {
                                    console.log(xhttp.responseText);
                                };
                                xhttp.open('POST', '{{ url_for('progress_tracker') }}', true);
                                xhttp.setRequestHeader('Content-Type', 'application/json');
                                xhttp.send(JSON.stringify({correctItem}));
                            }, 50);
                        };
                    };
                };
            };

            postCorrectItem();
        });
    };
</script>

<!-- While there is no value for 'sublist' -->
{% if not sublist %}

Choose a sublist:
<form action='{{url_for('quiz')}}' method='GET'>
    <ul>
        <li><button class='sublist' name='sublist' type='submit' id='sublist_button' value='1'>Sublist 1</button></li>
        <li><button class='sublist' name='sublist' type='submit' id='sublist_button' value='2'>Sublist 2</button></li>
        <li><button class='sublist' name='sublist' type='submit' id='sublist_button' value='3'>Sublist 3</button></li>
    </ul>
</form>

{% endif %}

<!-- When 'sublist' has value -->
{% if sublist %}

    <p>You chose Sublist No. {{ sublist }}</p>

    <button id='submit' type='button'>Submit</button>

    {% for i in range(question_amount) %}

        {% set random_words = sample(words, 4) %}
        {% set question_type = range(1, 6)|choice %}
        {% set question_form_class = range(1, 4)|choice %}
        {% set question_word = random_words|choice %}

        {% set container_loop_index = loop.index %}

        <div id='c{{ container_loop_index }}'>
        {% if question_type == 1 %}
            <p>1. given def, answer the word</p>
            <p id='a{{ question_word.id }}{{ container_loop_index }}'>{{ question_word.definition[0] }} - what's the word?</p>

            {% for choice_word in random_words %}
               {% if loop.index == 3 %}
                   <br>
               {% endif %}

                   <button class='choices{{ container_loop_index }}' id='b{{ choice_word.id }}{{ container_loop_index }}'>{{ choice_word }}</button>
            {% endfor %}

            <script>
                rightOrWrong(    document.getElementById('a{{ question_word.id }}{{ container_loop_index }}'),
                                 document.querySelectorAll('.choices{{ container_loop_index }}'),
                                 document.getElementById('submit'))
            </script>

        {% elif question_type == 2 %}
            <p>2. given word, answer def</p>
            <p id='a{{ question_word.id }}{{ container_loop_index }}'>{{ question_word }} - what's the definition?</p>

            {% for choice_word in random_words %}
                {% if loop.index == 3 %}
                    <br>
                {% endif %}

                        <button class='choices{{ container_loop_index }}' id='b{{ choice_word.id }}{{ container_loop_index }}'>{{ choice_word.definition[0] }}</button>
            {% endfor %}

            <script>
                rightOrWrong(    document.getElementById('a{{ question_word.id }}{{ container_loop_index }}'),
                                 document.querySelectorAll('.choices{{ container_loop_index }}'),
                                 document.getElementById('submit'))
            </script>

        {% elif question_type == 3 %}
            <p>3. given word, answer synonym</p>
            <p id='a{{ question_word.id }}{{ container_loop_index }}'>{{ question_word }} - what's the synonym?</p>

            {% for choice_word in random_words %}
                    {% if loop.index == 3 %}
                        <br>
                    {% endif %}

                    <button class='choices{{ container_loop_index }}' id='b{{ choice_word.id }}{{ container_loop_index }}'>{{ choice_word.synonym[0] }}</button>
            {% endfor %}

            <script>
                rightOrWrong(    document.getElementById('a{{ question_word.id }}{{ container_loop_index }}'),
                                 document.querySelectorAll('.choices{{ container_loop_index }}'),
                                 document.getElementById('submit'))
            </script>

        <!-- This type of question will require a different
        function for right or wrong -->
        {% elif question_type == 4 %}
            <p>4. which form is this? (n, a, v)</p>
            <p id='a{{ question_form_class }}{{ container_loop_index }}'>{{ question_word.form[question_form_class - 1] }} - noun, verb, or adjective?</p>

            <button class='choices{{ container_loop_index }}' id='b1{{ container_loop_index }}'>noun</button>

            <button class='choices{{ container_loop_index }}' id='b2{{ container_loop_index }}'>adjective</button>

            <br>

            <button class='choices{{ container_loop_index }}' id='b3{{ container_loop_index }}'>verb</button>

            <script>
                rightOrWrong(    document.getElementById('a{{ question_form_class }}{{ container_loop_index }}'),
                                 document.querySelectorAll('.choices{{ container_loop_index }}'),
                                 document.getElementById('submit'))
            </script>

        {% elif question_type == 5 %}
            <p>5. given word, answer collocation</p>
            <p id='a{{ question_word.id }}{{ container_loop_index }}'>{{ question_word }} - what's the collocation?</p>

            {% for choice_word in random_words %}
                    {% if loop.index == 3 %}
                        <br>
                    {% endif %}

                    <button class='choices{{ container_loop_index }}' id='b{{ choice_word.id }}{{ container_loop_index }}'> {{ choice_word.collocation[0] }}</button>
            {% endfor %}

            <script>
                rightOrWrong(    document.getElementById('a{{ question_word.id }}{{ container_loop_index }}'),
                                 document.querySelectorAll('.choices{{ container_loop_index }}'),
                                 document.getElementById('submit'))
            </script>
        {% endif %}
        </div>
    {% endfor %}

{% endif %}

{% endblock %}